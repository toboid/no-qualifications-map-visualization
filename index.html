<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="libraries/d3.v3.js"></script>
    <script src="libraries/topojson.v0.js"></script>
    <script src="data/unqualified.js"></script>
    <script src="data/boundaries.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="colorbrewer.css" />
</head>
<body>
    <svg id="map" width="960" height="1160">
        <filter id="dropshadow">
            <feGaussianBlur stdDeviation="10"/> 
        </filter>
    </svg>
    <script>
        var svg = d3.select("#map");
        var width = svg.attr("width"),
            height = svg.attr("height");

        //var width = 960,
        //    height = 1160;

        //var svg = d3.select("body").append("svg")
        //    .attr("viewBox", "0 0 " + width + " " + height)
        //    .attr("width", width)
        //    .attr("height", height);

        //svg.append("filter")
        //    .attr("id", "dropshadow")
        //    .append("feGaussianBlur")
        //    .attr("stdDeviation", 5);

        var projection = d3.geo.albers()
            .center([0, 55.4])
            .rotate([4.4, 0])
            .parallels([50, 60])
            .scale(6000)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path().projection(projection);

        var colourScale = d3.scale.quantize()
            .domain([unqualified.summary.min_percent, unqualified.summary.max_percent])
            .range(d3.range(9).map(function (i) { return "q" + i + "-9"; }));

        // External boundary.
        svg.append("path")
            .datum(topojson.mesh(boundaries, boundaries.objects.regions, function (a, b) { return a === b }))
            .attr("d", path)
            .attr("class", "cntry-bndry-ext");

        // Constituencies.
        svg.append("g")
            .attr("class", "YlGn constituency")
            .selectAll("path")
            .data(topojson.object(boundaries, boundaries.objects.constituencies).geometries)
            .enter()
            .append("path")
            .attr("class", function (d) {
                return colourScale(unqualified.data[d.id].percent_unqual);
            })
            .attr("d", path);

        // Regions.
        svg.append("g")
            .attr("id", "regions")
            .attr("class", "region")
            .selectAll("path")
            .data(groupRegions(topojson.object(boundaries, boundaries.objects.regions).geometries))
            .enter()
            .append("path")
            .attr("d", path);

        // Groups geometries in the data set by region,
        // also removes any empty geometries (likely empty due to simplification).
        function groupRegions(data) {
            var grouped = d3.map(),
                results = [];

            for (var p in data) {
                var elem = data[p];
                if (elem.coordinates !== undefined) {
                    if (!grouped.has(elem.id)) {
                        grouped.set(elem.id, {
                            type: "GeometryCollection",
                            geometries: [elem]
                        });
                    }
                    else {
                        grouped.get(elem.id).geometries.push(elem);
                    }
                }
            }
            // Return as array.
            grouped.forEach(function (key, val) {
                results.push(val);
            });

            return results;
        }


    </script>
</body>
</html>